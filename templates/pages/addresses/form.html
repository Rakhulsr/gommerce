{{ define "auth/addresses_form" }}
 

<div class="container mx-auto px-4 py-8 max-w-2xl">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">
        {{ if .IsEdit }}Edit Alamat{{ else }}Tambah Alamat Baru{{ end }}
    </h1>

    {{/* Flash Message dari redirect */}}
    {{ if .Message }}
    <div id="flash-message" class="mb-4 p-4 rounded-lg relative flex items-center justify-between shadow-sm
        {{ if eq .MessageStatus "success" }} bg-green-50 border border-green-300 text-green-800
        {{ else if eq .MessageStatus "error" }} bg-red-50 border border-red-300 text-red-800
        {{ else if eq .MessageStatus "warning" }} bg-yellow-50 border border-yellow-300 text-yellow-800
        {{ else }} bg-blue-50 border border-blue-300 text-blue-800
        {{ end }}">
        <span>{{ .Message }}</span>
        <button type="button" class="ml-4 text-gray-700 hover:text-gray-900 focus:outline-none" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    {{ end }}
    
    {{/* Tampilkan error validasi dari map .Errors */}}
    {{ if .Errors }}
    <div class="mb-4 p-4 rounded-lg bg-red-50 border border-red-300 text-red-800 shadow-sm">
        <p class="font-bold mb-2">Terjadi kesalahan validasi:</p>
        <ul class="list-disc list-inside">
            {{ range $field, $msg := .Errors }}
                <li>{{ $msg }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}

    <form action="{{ .FormAction }}" method="POST" class="bg-white rounded-lg shadow-md p-8">
        {{ if .IsEdit }}
        <input type="hidden" name="_method" value="PUT">
        {{ end }}

        <div class="mb-4">
            <label for="name" class="block text-gray-700 text-sm font-bold mb-2">Nama Penerima / Alamat:</label>
            <input type="text" id="name" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline {{ if .Errors.name }}border-red-500{{ end }}" value="{{ if .AddressData }}{{ .AddressData.Name }}{{ end }}" required>
            {{ if .Errors.name }}<p class="text-red-500 text-xs italic mt-1">{{ .Errors.name }}</p>{{ end }}
        </div>

        <div class="mb-4">
            <label for="phone" class="block text-gray-700 text-sm font-bold mb-2">Nomor Telepon:</label>
            <input type="tel" id="phone" name="phone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline {{ if .Errors.phone }}border-red-500{{ end }}" value="{{ if .AddressData }}{{ .AddressData.Phone }}{{ end }}" required>
            {{ if .Errors.phone }}<p class="text-red-500 text-xs italic mt-1">{{ .Errors.phone }}</p>{{ end }}
        </div>

        <div class="mb-4">
            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
            <input type="email" id="email" name="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline {{ if .Errors.email }}border-red-500{{ end }}" value="{{ if .AddressData }}{{ .AddressData.Email }}{{ end }}" required>
            {{ if .Errors.email }}<p class="text-red-500 text-xs italic mt-1">{{ .Errors.email }}</p>{{ end }}
        </div>

        <div class="mb-4">
            <label for="address1" class="block text-gray-700 text-sm font-bold mb-2">Alamat Lengkap (Baris 1):</label>
            <input type="text" id="address1" name="address1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline {{ if .Errors.address1 }}border-red-500{{ end }}" value="{{ if .AddressData }}{{ .AddressData.Address1 }}{{ end }}" required>
            {{ if .Errors.address1 }}<p class="text-red-500 text-xs italic mt-1">{{ .Errors.address1 }}</p>{{ end }}
        </div>

        <div class="mb-4">
            <label for="address2" class="block text-gray-700 text-sm font-bold mb-2">Alamat (Baris 2) - Opsional:</label>
            <input type="text" id="address2" name="address2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline {{ if .Errors.address2 }}border-red-500{{ end }}" value="{{ if .AddressData }}{{ .AddressData.Address2 }}{{ end }}">
            {{ if .Errors.address2 }}<p class="text-red-500 text-xs italic mt-1">{{ .Errors.address2 }}</p>{{ end }}
        </div>

       <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="province_id" class="block text-gray-700 text-sm font-bold mb-2">Provinsi:</label>
                <select id="province_id" name="province_id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline {{ if .Errors.provinceid }}border-red-500{{ end }}" required>
                    <option value="">Pilih Provinsi</option>
                    {{ range .Provinces }}  
                        <option value="{{ .ID }}" {{ if $.AddressData }}{{ if eq $.AddressData.ProvinceID .ID }}selected{{ end }}{{ end }}>
                            {{ .Name }}
                        </option>
                    {{ end }}
                </select>
                {{ if .Errors.provinceid }}<p class="text-red-500 text-xs italic mt-1">{{ .Errors.provinceid }}</p>{{ end }}
            </div>
            <div>
                <label for="city_id" class="block text-gray-700 text-sm font-bold mb-2">Kota:</label>
                <select id="city_id" name="city_id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline {{ if .Errors.cityid }}border-red-500{{ end }}" required>
                    <option value="">Pilih Kota</option>
                    {{ if .AddressData }}
                        {{ if .AddressData.ProvinceID }}
                            {{/* Jika ada data form, tampilkan kota yang sudah dipilih */}}
                            <option value="{{ .AddressData.CityID }}" selected>{{ .AddressData.CityName }}</option>
                        {{ end }}
                    {{ else }}
                        {{/* Default jika tidak ada data form */}}
                        <option value="" selected>Pilih Kota</option>
                    {{ end }}
                </select>
                {{ if .Errors.cityid }}<p class="text-red-500 text-xs italic mt-1">{{ .Errors.cityid }}</p>{{ end }}
            </div>
        </div>

        <div class="mb-6">
            <label for="post_code" class="block text-gray-700 text-sm font-bold mb-2">Kode Pos:</label>
            <input type="text" id="post_code" name="post_code" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline {{ if .Errors.postcode }}border-red-500{{ end }}" value="{{ if .AddressData }}{{ .AddressData.PostCode }}{{ end }}" required>
            {{ if .Errors.postcode }}<p class="text-red-500 text-xs italic mt-1">{{ .Errors.postcode }}</p>{{ end }}
        </div>


        <div class="flex items-center justify-between">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 focus:outline-none focus:shadow-outline">
                {{ if .IsEdit }}Perbarui Alamat{{ else }}Simpan Alamat{{ end }}
            </button>
            <a href="/addresses" class="inline-block align-baseline font-bold text-sm text-gray-600 hover:text-gray-800">
                Batal
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const provinceSelect = document.getElementById('province_id');
    const citySelect = document.getElementById('city_id');

    
    const loadCities = (provinceId, selectedCityId = null) => {
        citySelect.innerHTML = '<option value="">Memuat kota...</option>'; 
        citySelect.disabled = true;

        if (provinceId) {
            fetch(`/cities?province_id=${provinceId}`)
                .then(response => {
                    if (!response.ok) {
                        console.error('HTTP Error:', response.status, response.statusText);
                        return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.cities) {
                        citySelect.innerHTML = '<option value="">Pilih Kota</option>';
                        data.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.city_id;   
                            option.textContent = city.city_name; 
                            if (selectedCityId && String(city.city_id) === String(selectedCityId)) {
                                option.selected = true;
                            }
                            citySelect.appendChild(option);
                        });
                    } else {
                        console.error('Format data kota tidak sesuai atau kosong:', data);
                        citySelect.innerHTML = '<option value="">Gagal memuat kota</option>';
                    }
                    citySelect.disabled = false;
                })
                .catch(error => {
                    console.error('Ada masalah dengan operasi fetch:', error);
                    citySelect.innerHTML = '<option value="">Gagal memuat kota</option>';
                    citySelect.disabled = false;
                });
        } else {
            citySelect.innerHTML = '<option value="">Pilih Provinsi Dahulu</option>';
            citySelect.disabled = false;
        }
    };

    
    if (provinceSelect) {
        provinceSelect.addEventListener('change', function() {
            loadCities(this.value);
        });
    }

    
    const initialProvinceId = provinceSelect ? provinceSelect.value : '';
    const initialCityId = "{{ if .AddressData }}{{ .AddressData.CityID }}{{ end }}"; 

    if (initialProvinceId) {
        loadCities(initialProvinceId, initialCityId);
    } else {
        citySelect.innerHTML = '<option value="">Pilih Provinsi Dahulu</option>';
        citySelect.disabled = true;
    }
});
</script>
{{ end }}
