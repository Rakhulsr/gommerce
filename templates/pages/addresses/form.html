{{ define "auth/addresses_form" }}
    <style>
    /* Style untuk input dan saran autocomplete */
    .autocomplete-container {
        position: relative;
    }
    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        /*position the autocomplete items to be the same width as the container:*/
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px; /* Batasi tinggi untuk scroll */
        overflow-y: auto; /* Aktifkan scroll */
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 0.375rem;
    }
    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff; 
        border-bottom: 1px solid #d4d4d4; 
        color: #333; /* **PERBAIKAN: Menambahkan warna teks eksplisit** */
    }
    .autocomplete-items div:hover {
        /*when hovering an item:*/
        background-color: #e9e9e9;
    }
    .autocomplete-active {
        /*when navigating through the items using the arrow keys:*/
        background-color: #4f46e5 !important; 
        color: #ffffff;
    }
    /* Style untuk form-select (jika masih ada di tempat lain atau untuk referensi) */
    .form-select {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        border-color: #d1d5db;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    .form-select:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
    }
    </style>
    <main class="flex-grow container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">{{ .Title }}</h2>

            {{ if .Message }}
            <div class="p-4 mb-4 text-sm rounded-lg 
                {{ if eq .MessageStatus "success" }}bg-green-100 text-green-800{{ end }}
                {{ if eq .MessageStatus "error" }}bg-red-100 text-red-800{{ end }}
                {{ if eq .MessageStatus "warning" }}bg-yellow-100 text-yellow-800{{ end }}
                {{ if eq .MessageStatus "info" }}bg-blue-100 text-blue-800{{ end }}" role="alert">
                {{ .Message }}
            </div>
            {{ end }}

            <form action="{{ .FormAction }}" method="POST" class="space-y-6">
                
                <!-- Hidden input untuk menyimpan ID lokasi RajaOngkir (kelurahan/desa) -->
                <input type="hidden" name="subdistrict_id" id="subdistrict_id_input" value="{{ .Address.LocationID }}">

                <!-- Hidden inputs untuk menyimpan nama lokasi yang dipilih (akan diisi oleh JS) -->
                <input type="hidden" name="province_name" id="province_name_input" value="{{ .ProvinceName }}">
                <input type="hidden" name="city_name" id="city_name_input" value="{{ .CityName }}">
                <input type="hidden" name="district_name" id="district_name_input" value="{{ .DistrictName }}">
                <input type="hidden" name="subdistrict_name" id="subdistrict_name_input" value="{{ .SubdistrictName }}">

                <div>
                    <label for="address1" class="block text-sm font-medium text-gray-700">Alamat Lengkap (Jl, No. Rumah, RT/RW)</label>
                    <input type="text" id="address1" name="address1" value="{{ .Address.Address1 }}"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        required>
                    {{ with .Errors.Address1 }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>

                <div>
                    <label for="address2" class="block text-sm font-medium text-gray-700">Detail Lain (Opsional, cth: Blok, Unit, Patokan)</label>
                    <input type="text" id="address2" name="address2" value="{{ .Address.Address2 }}"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    {{ with .Errors.Address2 }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>

                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Nomor Telepon</label>
                    <input type="tel" id="phone" name="phone" value="{{ .Address.Phone }}"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        required>
                    {{ with .Errors.Phone }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>

                <!-- INPUT TEKS TUNGGAL UNTUK PENCARIAN LOKASI (PROVINSI, KOTA, KECAMATAN, KELURAHAN/DESA) -->
                <div class="autocomplete-container">
                    <label for="location_search_input" class="block text-sm font-medium text-gray-700">Cari Provinsi, Kota, Kecamatan, Kelurahan/Desa</label>
                    <input type="text" id="location_search_input" 
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        required placeholder="Contoh: Mekar Jaya Depok" 
                        value="{{ if .SubdistrictName }}{{ .SubdistrictName }}, {{ .DistrictName }}, {{ .CityName }}, {{ .ProvinceName }}{{ end }}">
                    <div id="autocomplete-list" class="autocomplete-items"></div>
                    {{ with .Errors.Location }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>
                <!-- Hapus dropdown lama -->
                <!--
                <div>
                    <label for="province_select" class="block text-sm font-medium text-gray-700">Provinsi</label>
                    <select id="province_select" name="province_name_display" class="form-select" required>
                        <option value="">-- Pilih Provinsi --</option>
                    </select>
                    {{ with .Errors.Province }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>
                <div>
                    <label for="city_select" class="block text-sm font-medium text-gray-700">Kota/Kabupaten</label>
                    <select id="city_select" name="city_name_display" class="form-select" disabled required>
                        <option value="">-- Pilih Kota/Kabupaten --</option>
                    </select>
                    {{ with .Errors.City }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>
                <div>
                    <label for="district_select" class="block text-sm font-medium text-gray-700">Kecamatan</label>
                    <select id="district_select" name="district_name_display" class="form-select" disabled required>
                        <option value="">-- Pilih Kecamatan --</option>
                    </select>
                    {{ with .Errors.District }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>
                <div>
                    <label for="subdistrict_select" class="block text-sm font-medium text-gray-700">Kelurahan/Desa</label>
                    <select id="subdistrict_select" name="subdistrict_name_display" class="form-select" disabled required>
                        <option value="">-- Pilih Kelurahan/Desa --</option>
                    </select>
                    {{ with .Errors.Subdistrict }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>
                -->

                <div>
                    <label for="zip_code_input" class="block text-sm font-medium text-gray-700">Kode Pos</label>
                    <input type="text" id="zip_code_input" name="post_code" value="{{ .Address.PostCode }}"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        required placeholder="Contoh: 12345">
                    {{ with .Errors.PostCode }}<p class="mt-1 text-sm text-red-600">{{ . }}</p>{{ end }}
                </div>

                <div class="flex items-center">
                    <input id="is_primary" name="is_primary" type="checkbox" {{ if .Address.IsPrimary }}checked{{ end }}
                        class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                    <label for="is_primary" class="ml-2 block text-sm text-gray-900">Jadikan Alamat Utama</label>
                </div>


                <div class="flex justify-end space-x-3">
                    <a href="/addresses" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Batal
                    </a>
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                        Simpan Alamat
                    </button>
                </div>
            </form>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const locationSearchInput = document.getElementById('location_search_input');
            const autocompleteList = document.getElementById('autocomplete-list');
            const subdistrictIdInput = document.getElementById('subdistrict_id_input');
            const provinceNameInput = document.getElementById('province_name_input');
            const cityNameInput = document.getElementById('city_name_input');
            const districtNameInput = document.getElementById('district_name_input');
            const subdistrictNameInput = document.getElementById('subdistrict_name_input');
            const zipCodeInput = document.getElementById('zip_code_input');

            let currentFocus = -1;
            let timeout = null;

            // Fungsi untuk menutup daftar autocomplete
            function closeAllLists(elmnt) {
                const items = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < items.length; i++) {
                    if (elmnt != items[i] && elmnt != locationSearchInput) {
                        items[i].parentNode.removeChild(items[i]);
                    }
                }
            }

            // Fungsi untuk menambahkan kelas "active" ke item autocomplete
            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }

            // Fungsi untuk menghapus kelas "active" dari item autocomplete
            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            // Event listener untuk input pencarian lokasi
            locationSearchInput.addEventListener('input', function() {
                const val = this.value;
                closeAllLists();
                if (!val || val.length < 3) { // Minimal 3 karakter untuk pencarian
                    return false;
                }

                // Clear previous timeout
                if (timeout) {
                    clearTimeout(timeout);
                }

                // Set new timeout for debounce
                timeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/komerce/search-destinations?query=${encodeURIComponent(val)}&limit=10&offset=0`);
                        const data = await response.json();

                        if (data.success && data.data) {
                            currentFocus = -1;
                            const suggestions = data.data;

                            // Buat div untuk daftar autocomplete
                            const a = document.createElement("DIV");
                            a.setAttribute("id", this.id + "autocomplete-list");
                            a.setAttribute("class", "autocomplete-items");
                            this.parentNode.appendChild(a);

                            if (suggestions.length > 0) {
                                suggestions.forEach(item => {
                                    // Mengakses properti sesuai dengan respons API Komerce yang baru (snake_case)
                                    const sub = item.subdistrict_name || '';
                                    const district = item.district_name || '';
                                    const city = item.city_name || '';
                                    const province = item.province_name || '';
                                    const postal = item.zip_code || '';
                                    const id = item.id || '';
                                    const label = item.label || ''; // Menggunakan label jika tersedia

                                    // Bangun string tampilan. Prioritaskan 'label' jika ada, jika tidak, gabungkan komponen
                                    let displayLocationName;
                                    if (label) {
                                        displayLocationName = label;
                                    } else {
                                        let parts = [];
                                        if (sub) parts.push(sub);
                                        if (district) parts.push(district);
                                        if (city) parts.push(city);
                                        if (province) parts.push(province);
                                        displayLocationName = parts.join(', ');
                                    }
                                    
                                    const optionText = `${displayLocationName} ${postal ? '(' + postal + ')' : ''}`;
                                    
                                    // **DEBUGGING: Log the optionText to console**
                                    console.log("Option Text:", optionText);

                                    const b = document.createElement("DIV");
                                    b.innerHTML = optionText; // Tampilan di dropdown
                                    
                                    // Simpan data lengkap item di dataset untuk akses mudah
                                    b.dataset.id = id;
                                    b.dataset.subdistrictName = sub;
                                    b.dataset.districtName = district;
                                    b.dataset.cityName = city;
                                    b.dataset.provinceName = province;
                                    b.dataset.zipCode = postal;

                                    b.addEventListener("click", function() {
                                        // Isi input pencarian dengan label lengkap
                                        locationSearchInput.value = this.textContent.trim(); // Gunakan textContent dari div yang diklik
                                        
                                        // Isi hidden inputs dengan data yang dipilih (menggunakan dataset yang baru disimpan)
                                        subdistrictIdInput.value = this.dataset.id;
                                        subdistrictNameInput.value = this.dataset.subdistrictName;
                                        districtNameInput.value = this.dataset.districtName;
                                        cityNameInput.value = this.dataset.cityName;
                                        provinceNameInput.value = this.dataset.provinceName;
                                        zipCodeInput.value = this.dataset.zipCode;

                                        closeAllLists();
                                    });
                                    a.appendChild(b);
                                });
                            } else {
                                const b = document.createElement("DIV");
                                b.innerHTML = "Tidak ada hasil ditemukan.";
                                a.appendChild(b);
                            }
                        } else {
                            const a = document.createElement("DIV");
                            a.setAttribute("id", this.id + "autocomplete-list");
                            a.setAttribute("class", "autocomplete-items");
                            this.parentNode.appendChild(a);
                            const b = document.createElement("DIV");
                            b.innerHTML = "Tidak ada hasil ditemukan atau terjadi kesalahan.";
                            a.appendChild(b);
                        }
                    } catch (error) {
                        console.error('Error fetching suggestions:', error);
                        closeAllLists();
                        const a = document.createElement("DIV");
                        a.setAttribute("id", this.id + "autocomplete-list");
                        a.setAttribute("class", "autocomplete-items");
                        this.parentNode.appendChild(a);
                        const b = document.createElement("DIV");
                        b.innerHTML = "Gagal memuat saran. Coba lagi.";
                        a.appendChild(b);
                    }
                }, 300); // Debounce 300ms
            });

            // Event listener untuk keyboard (panah atas/bawah, Enter)
            locationSearchInput.addEventListener('keydown', function(e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) { // Panah bawah
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // Panah atas
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) { // Enter
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });

            // Tutup daftar autocomplete jika user mengklik di luar input
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });

            // Inisialisasi: Jika ada nilai awal (mode edit), isi input pencarian
            const initialSubdistrictName = "{{ .SubdistrictName }}";
            const initialDistrictName = "{{ .DistrictName }}";
            const initialCityName = "{{ .CityName }}";
            const initialProvinceName = "{{ .ProvinceName }}";
            const initialPostCode = "{{ .PostCode }}"; // Ambil juga kode pos

            if (initialSubdistrictName || initialDistrictName || initialCityName || initialProvinceName || initialPostCode) {
                let initialParts = [];
                if (initialSubdistrictName) initialParts.push(initialSubdistrictName);
                if (initialDistrictName) initialParts.push(initialDistrictName);
                if (initialCityName) initialParts.push(initialCityName);
                if (initialProvinceName) initialParts.push(initialProvinceName);
                
                let initialDisplay = initialParts.join(', ');
                if (initialPostCode) {
                    initialDisplay += ` (${initialPostCode})`;
                }
                locationSearchInput.value = initialDisplay;
            }
        });
    </script>
{{ end }}
