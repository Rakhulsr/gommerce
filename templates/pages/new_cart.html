{{ define "carts" }}

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .animate-fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
    </style>

    
    <section class="flex-grow max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center lg:text-left">
            ðŸ›’ Keranjang Belanja Anda
        </h1>

        {{ if .Message }}
        <div id="flash-message" class="max-w-7xl mx-auto mt-4 px-4 sm:px-6 lg:px-8 animate-fade-in-down">
            <div class="mb-4 p-4 rounded-lg relative flex items-center justify-between shadow-sm
                {{ if eq .MessageStatus "success" }} bg-green-50 border border-green-300 text-green-800
                {{ else if eq .MessageStatus "error" }} bg-red-50 border border-red-300 text-red-800
                {{ else if eq .MessageStatus "warning" }} bg-yellow-50 border border-yellow-300 text-yellow-800
                {{ else }} bg-blue-50 border border-blue-300 text-blue-800
                {{ end }}">
                <span>{{ .Message }}</span>
                <button type="button" class="ml-4 text-gray-700 hover:text-gray-900 focus:outline-none" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        {{ end }}


        {{ if .cart.CartItems }}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">

            <div class="lg:col-span-2 bg-white shadow-xl rounded-lg p-6 border border-gray-100">
                <div class="space-y-6 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">
                    
                    {{ if .updated }}
                    <div id="update-success-notification" class="relative mb-4 p-4 rounded-lg bg-emerald-50 border border-emerald-300 text-emerald-800 font-medium flex items-center gap-3 animate-fade-in">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg> âœ… Item berhasil diperbarui
                        <button type="button" class="absolute top-2 right-2 text-emerald-700 hover:text-emerald-900 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 rounded-full p-1" onclick="this.parentElement.remove()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    {{ end }}

                    {{ range .cart.CartItems }}
                        <div class="flex flex-col sm:flex-row items-center sm:items-start justify-between border-b border-gray-200 pb-6 last:border-b-0 last:pb-0 pt-4 animate-fade-in-up">
                           <div class="flex-shrink-0 mr-0 sm:mr-6 mb-4 sm:mb-0">
                                {{ $imageURL := "https://placehold.co/112x112/E0E0E0/333333?text=No+Image" }}
                                {{ if gt (len .Product.ProductImages) 0 }}
                                    {{ $imageURL = (index .Product.ProductImages 0).Path }} 
                                {{ end }}
                                <img src="{{ $imageURL }}" alt="{{ .Product.Name }}" class="w-28 h-28 object-cover rounded-lg shadow-md border border-gray-100">
                            </div>

                            <div class="flex-1 text-center sm:text-left mb-4 sm:mb-0">    
                                <a href="/products/{{ .Product.Slug }}" class="font-semibold text-xl text-gray-800 mb-1 hover:text-emerald-600 transition duration-150 ease-in-out block">{{ .Product.Name }}</a>
                                <p class="text-sm text-gray-600">Harga Satuan (Asli): <span class="text-gray-700">{{ rupiah .Price }}</span></p>
                                {{ if or (isGreaterThanZero .DiscountPercent) (isGreaterThanZero .DiscountAmount) }}
                                    <p class="text-sm text-red-600 font-medium">Diskon: 
                                        {{ if isGreaterThanZero .DiscountPercent }}
                                            {{ .DiscountPercent.StringFixed 2 }}%
                                        {{ else }}
                                            {{ rupiah .DiscountAmount }}
                                        {{ end }}
                                    </p>
                                    <p class="text-sm text-gray-600 font-medium">Harga Setelah Diskon: <span class="font-bold text-emerald-700">{{ rupiah .FinalPriceUnit }}</span></p>
                                {{ else }}
                                    <p class="text-sm text-gray-600 font-medium">Diskon: -</p>
                                    <p class="text-sm text-gray-600 font-medium">Harga Setelah Diskon: <span class="font-bold text-emerald-700">{{ rupiah .FinalPriceUnit }}</span></p>
                                {{ end }}
                                <p class="text-sm text-emerald-600 mt-1 font-medium">Stok tersedia: <span class="font-bold">{{ .Product.Stock }}</span></p>
                            </div>

                            <div class="text-right flex flex-col items-center sm:items-end justify-between space-y-4 sm:space-y-2">
                                <div class="flex items-center gap-3">
                                    <form action="/carts/update" method="POST" class="flex items-center update-cart-item-form">
                                        <input type="hidden" name="product_id" value="{{ .ProductID }}">
                                        <input 
                                            type="number" 
                                            name="qty" 
                                            value="{{ .Qty }}" 
                                            min="1" 
                                            max="{{ .Product.Stock }}" 
                                            class="w-20 border border-gray-300 rounded-md text-center py-2 text-base font-medium focus:border-emerald-500 focus:ring-emerald-500 transition duration-150 ease-in-out"
                                        >
                                        <input type="hidden" name="_method" value="PUT">
                                        <button 
                                            type="submit" 
                                            class="ml-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 shadow-sm"
                                        >
                                            Update
                                        </button>
                                    </form>

                                    <form action="/carts/delete" method="POST" class="delete-cart-item-form">
                                        <input type="hidden" name="product_id" value="{{ .ProductID }}">
                                        <input type="hidden" name="_method" value="DELETE">
                                        <button 
                                            type="submit" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 shadow-sm"
                                        >
                                            Hapus
                                        </button>
                                    </form>
                                </div>
                                <p class="text-lg font-bold text-gray-900">Subtotal: {{ rupiah .Subtotal }}</p>
                            </div>
                        </div>
                    {{ end }}
                </div>
            </div>

            <div class="bg-white shadow-xl rounded-lg p-6 border border-gray-100 h-fit">
                <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3 border-gray-200">ðŸ§¾ Ringkasan Pesanan</h2>
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Subtotal Produk</span>
                        <span class="font-semibold">{{ rupiah .cart.BaseTotalPrice }}</span>
                    </div>
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Diskon Keranjang</span>
                        <span class="text-emerald-500 font-semibold">-{{ rupiah .cart.DiscountAmount }}</span>
                    </div>
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Pajak ({{ .cart.TaxPercent.StringFixed 2 }}%)</span>
                        <span class="text-red-600 font-semibold">+{{ rupiah .cart.TaxAmount }}</span>
                    </div>
                    <div class="border-t border-gray-200 pt-4 mt-4"></div>
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Total Berat</span>
                        <span class="font-semibold">{{ .cart.TotalWeight.StringFixed 2 }} gram</span>
                    </div>
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Subtotal Pesanan (Sebelum Ongkir)</span>
                        <span class="text-emerald-700 font-semibold" id="cart-grand-total-before-shipping">{{ rupiah .cart.GrandTotal }}</span>
                    </div>
                </div>

                <form method="POST" action="/checkout/process" id="checkout-form"> 
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 border-gray-200">Pilih Alamat & Pengiriman</h3>
                    
                    <div class="form-group mb-4">
                        <label for="address_id" class="block text-sm font-medium text-gray-700 mb-1">Pilih Alamat Pengiriman</label>
                        <select name="selected_address_id" id="address_id" class="form-control block w-full border-gray-300 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2.5">
                            <option value="" selected>--Pilih Alamat--</option>
                            {{ range .Addresses }}
                            <option value="{{ .ID }}" 
                                    data-location-id="{{ .LocationID }}" 
                                    data-location-name="{{ .LocationName }}"
                                    {{ if eq .ID $.PrimaryAddress.ID }}selected{{ end }}>
                                {{ .Name }} ({{ .Address1 }}, {{ .LocationName }})
                            </option>
                            {{ end }}
                        </select>
                        <p class="text-sm text-gray-500 mt-1">Belum ada alamat? <a href="/addresses/add" class="text-blue-600 hover:underline">Tambahkan alamat baru</a>.</p>
                    </div>

                    <div class="form-group mb-4">
                        <label for="courier_select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Kurir</label>
                        <select name="courier" id="courier_select" class="form-control block w-full border-gray-300 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2.5" disabled>
                            <option value="">--Pilih Kurir--</option>
                            {{ range .couriers }}
                            <option value="{{ .Code }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <div class="form-group mb-4">
                        <label for="shipping_fee_options" class="block text-sm font-medium text-gray-700 mb-1">Pilih Opsi Pengiriman</label>
                        <select name="shipping_fee_options" id="shipping_fee_options" class="form-control block w-full border-gray-300 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2.5" disabled>    
                            <option value="" selected>--Pilih Opsi Pengiriman--</option>
                        </select>
                        <p id="shipping-calculation-msg" class="text-sm mt-2 text-gray-600"></p>
                    </div>
                    <input type="hidden" id="total_weight_input" value="{{ .cart.TotalWeight.InexactFloat64 }}">
                    <input type="hidden" id="origin_location_id_input" value="{{ .OriginLocationID }}">
                    
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <div class="flex justify-between text-base font-medium text-gray-900">
                            <p>Total Ongkos Kirim</p>
                            <p id="shipping-fee-display">Rp 0</p>
                        </div>
                        <div class="flex justify-between text-xl font-semibold text-gray-900 mt-4">
                            <p>Total Pembayaran</p>
                            <p id="grand-total-display">{{ rupiah .cart.GrandTotal }}</p>
                        </div>
                        <input type="hidden" id="cart_grand_total_amount_for_js" value="{{ .cart.GrandTotal.InexactFloat64 }}">
                    </div>
                    
                    <input type="hidden" id="checkout_shipping_cost" name="shipping_cost" value="0">
                    <input type="hidden" id="checkout_shipping_service_code" name="shipping_service_code" value="">
                    <input type="hidden" id="checkout_shipping_service_name" name="shipping_service_name" value="">
                    <input type="hidden" id="checkout_final_total_price" name="final_total_price" value="0">
                    
                    <button type="submit" id="proceedToCheckoutBtn" class="w-full mt-4 bg-emerald-600 text-white py-3 px-4 rounded-lg hover:bg-emerald-700 text-lg font-semibold shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Lanjutkan ke Pembayaran
                    </button>
                </form>
            </div>
        </div>

        {{ else }}
        <div class="bg-white p-12 rounded-lg shadow-lg text-center mt-12 border border-gray-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-24 w-24 text-gray-400 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.3 5.6a1 1 0 001 1.4h12.6a1 1 0 001-1.4L17 13m-2-8a1 1 0 100-2 1 1 0 000 2zM9 21a1 1 0 100-2 1 1 0 000 2z" />
            </svg>
            <p class="text-2xl text-gray-600 font-semibold mb-6">Keranjang Anda masih kosong.</p>
            <a href="/products" class="inline-flex items-center bg-emerald-600 text-white py-3 px-6 rounded-lg hover:bg-emerald-700 text-lg font-semibold shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                Mulai Belanja Sekarang
            </a>
        </div>
        {{ end }}

    </section>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        /**
         * @param {number|string} amount - Jumlah yang akan diformat.
         * @returns {string} - String format Rupiah.
         */
        function formatCurrency(amount) {
            const num = parseFloat(amount);
            if (isNaN(num)) {
                return "Rp 0";
            }
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(num);
        }

        document.addEventListener('DOMContentLoaded', function() {
           
            const flashMessage = document.getElementById('flash-message');
            if (flashMessage) {
                setTimeout(() => {
                    flashMessage.classList.add('animate-fade-out');
                    flashMessage.addEventListener('animationend', () => {
                        flashMessage.remove();
                    });
                }, 5000);
            }

            const elements = {
                addressSelect: document.getElementById('address_id'),
                courierSelect: document.getElementById('courier_select'),
                shippingFeeSelect: document.getElementById('shipping_fee_options'),
                shippingCalculationMsg: document.getElementById('shipping-calculation-msg'),
                shippingFeeDisplay: document.getElementById('shipping-fee-display'),
                grandTotalDisplay: document.getElementById('grand-total-display'),
                cartGrandTotalBeforeShipping: parseFloat("{{ .cart.GrandTotal.InexactFloat64 }}") || 0,
                totalWeightInput: parseFloat("{{ .cart.TotalWeight.InexactFloat64 }}") || 1,
                proceedToCheckoutBtn: document.getElementById('proceedToCheckoutBtn'),
                
                checkoutShippingCostInput: document.getElementById('checkout_shipping_cost'),
                checkoutShippingServiceCodeInput: document.getElementById('checkout_shipping_service_code'),
                checkoutShippingServiceNameInput: document.getElementById('checkout_shipping_service_name'),
                checkoutFinalTotalPriceInput: document.getElementById('checkout_final_total_price'),
            };

            let selectedDestinationLocationID = null;
            let totalWeight = elements.totalWeightInput; 
            let cartGrandTotal = elements.cartGrandTotalBeforeShipping; 

            // Ensure totalWeight is at least 1 gram if 0
            if (totalWeight <= 0) {
                totalWeight = 1;
            }

            const originLocationID = parseInt("{{ .OriginLocationID }}", 10) || 0; 
            if (originLocationID === 0) {
                console.error('Error: Origin Location ID tidak ditemukan atau tidak valid dari backend.');
                setShippingMessage('Konfigurasi toko asal pengiriman tidak valid. Mohon hubungi admin.', 'error');
            }


            /**
             * Updates the displayed grand total.
             * @param {number|string} selectedShippingCostValue - The selected shipping cost.
             */
            function updateGrandTotalDisplay(selectedShippingCostValue = 0) {
                const currentShippingFee = parseFloat(selectedShippingCostValue) || 0;
                const grandTotalCalculated = cartGrandTotal + currentShippingFee;

                elements.shippingFeeDisplay.textContent = formatCurrency(currentShippingFee);
                elements.grandTotalDisplay.textContent = formatCurrency(grandTotalCalculated);
                elements.checkoutFinalTotalPriceInput.value = grandTotalCalculated.toFixed(2); // Update hidden input
            }

            /**
             * Resets shipping related elements (except courier select disabled state).
             */
            function resetShippingOptionsAndButton() {
                elements.shippingFeeSelect.innerHTML = `<option value="" selected>--Pilih Opsi Pengiriman--</option>`;
                elements.shippingFeeSelect.disabled = true;
                
                elements.checkoutShippingCostInput.value = 0;
                elements.checkoutShippingServiceCodeInput.value = '';
                elements.checkoutShippingServiceNameInput.value = '';
                
                elements.proceedToCheckoutBtn.disabled = true;
                setShippingMessage('');
                updateGrandTotalDisplay(0); // Reset total payment to initial cart total
            }

            /**
             * Displays a message related to shipping calculation.
             * @param {string} message - The message to display.
             * @param {'success'|'warning'|'error'|''} type - Message type (for styling).
             */
            function setShippingMessage(message, type = '') {
                elements.shippingCalculationMsg.textContent = message;
                elements.shippingCalculationMsg.className = 'text-sm mt-2'; // Reset classes

                elements.shippingCalculationMsg.classList.remove('text-red-500', 'text-yellow-500', 'text-green-500');
                if (type === 'error') {
                    elements.shippingCalculationMsg.classList.add('text-red-500');
                } else if (type === 'warning') {
                    elements.shippingCalculationMsg.classList.add('text-yellow-500');
                } else if (type === 'success') {
                    elements.shippingCalculationMsg.classList.add('text-green-500');
                }
            }

            // Function to calculate shipping cost using Komerce API
            async function calculateShippingCost() {
                const destinationID = selectedDestinationLocationID;
                const courier = elements.courierSelect.value;

                resetShippingOptionsAndButton(); // Only reset shipping options and button here

                console.log('--- Calculating Shipping Cost ---');
                console.log('originLocationID (from HTML):', originLocationID);
                console.log('destinationLocationID (from HTML):', destinationID);
                console.log('totalWeight:', totalWeight);
                console.log('courier:', courier);

                if (originLocationID === 0) {
                    setShippingMessage('Kota asal pengiriman belum ditentukan (konfigurasi backend).', 'error');
                    return;
                }
                if (totalWeight <= 0) {
                    setShippingMessage('Berat total produk harus lebih dari 0.', 'error');
                    return;
                }
                if (!destinationID || parseInt(destinationID, 10) === 0) {
                    setShippingMessage('Mohon pilih Alamat Pengiriman yang valid.', 'warning');
                    return;
                }
                if (!courier) {
                    setShippingMessage('Mohon pilih Kurir.', 'warning');
                    return;
                }

                setShippingMessage('Memuat opsi pengiriman...', 'warning');
                elements.shippingFeeSelect.innerHTML = '<option value="" selected>--Memuat Opsi Pengiriman--</option>';
                
                try {
                    const response = await fetch('/api/komerce/calculate-shipping-cost', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', // Sending JSON
                        },
                        body: JSON.stringify({
                            origin: originLocationID,
                            destination: parseInt(destinationID, 10), // Ensure this is an int
                            weight: parseInt(totalWeight, 10), // Ensure this is an int
                            courier: courier,
                        })
                    });

                    const data = await response.json();

                    if (!response.ok || data.status === 'error' || !data.success) { // Check data.success as well
                        let displayMessage = data.message || `Error ${response.status}: Gagal menghitung ongkos kirim.`;
                        
                        if (response.status === 404 && data.meta && data.meta.message && data.meta.message.includes("Calculate Domestic Shipping Cost not found")) {
                            displayMessage = `Opsi pengiriman tidak tersedia untuk kurir '${courier}' pada rute ini. Mohon coba kurir lain atau hubungi dukungan.`;
                        } else if (response.status === 400 && data.meta && data.meta.message) {
                            displayMessage = `Kesalahan validasi dari API: ${data.meta.message}. Mohon periksa input Anda.`;
                        }

                        throw new Error(displayMessage);
                    }

                    elements.shippingFeeSelect.innerHTML = '<option value="" selected>--Pilih Opsi Pengiriman--</option>';

                    let optionsFound = false; 
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(service => { 
                            const serviceName = `${service.name} - ${service.service} (${service.description})`; 
                            const costValue = service.cost; 
                            const etd = service.etd; 
                            
                            const optionText = `${serviceName} - ${formatCurrency(costValue)} (Estimasi: ${etd} hari)`;
                            const optionValue = `${costValue}|${service.code}|${service.service}|${serviceName}`; 
                            const option = new Option(optionText, optionValue);
                            elements.shippingFeeSelect.add(option);
                            optionsFound = true; 
                        });
                    }

                    if (optionsFound) {
                        elements.shippingFeeSelect.disabled = false;
                        setShippingMessage('Pilih opsi pengiriman.', 'success');
                    } else {
                        setShippingMessage('Tidak ada opsi pengiriman tersedia untuk rute dan kurir ini. Coba kurir lain atau periksa rute.', 'warning');
                        elements.shippingFeeSelect.innerHTML = '<option value="" selected>--Tidak Tersedia--</option>';
                    }
                } catch (error) {
                    console.error('Error dalam calculateShippingCost:', error);
                    setShippingMessage(error.message || 'Terjadi kesalahan jaringan saat menghitung ongkir.', 'error');
                    elements.shippingFeeSelect.innerHTML = '<option value="" selected>--Gagal Memuat--</option>';
                } finally {
                    updateGrandTotalDisplay(elements.checkoutShippingCostInput.value);
                }
            }

            // --- Event Listeners ---

            // Event listener for address selection change
            elements.addressSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    selectedDestinationLocationID = selectedOption.dataset.locationId;
                    elements.courierSelect.disabled = false; // AKTIFKAN KURIR DI SINI
                    elements.courierSelect.value = ""; // Reset courier selection
                    resetShippingOptionsAndButton(); // Hanya reset opsi pengiriman dan tombol
                    setShippingMessage('Pilih kurir untuk menghitung ongkos kirim.', 'success');
                } else {
                    selectedDestinationLocationID = null;
                    elements.courierSelect.value = ""; // Reset courier selection
                    elements.courierSelect.disabled = true; // NONAKTIFKAN KURIR JIKA TIDAK ADA ALAMAT
                    resetShippingOptionsAndButton(); // Reset opsi pengiriman dan tombol
                    setShippingMessage('Mohon pilih alamat pengiriman.', 'warning');
                }
            });

            // Event listener for courier selection change
            elements.courierSelect.addEventListener('change', function() {
                if (this.value && selectedDestinationLocationID) {
                    calculateShippingCost();
                } else {
                    resetShippingOptionsAndButton(); // Hanya reset opsi pengiriman dan tombol
                    setShippingMessage('Pilih kurir untuk menghitung ongkos kirim.', 'warning');
                }
            });

            // Event listener for shipping option selection change
            elements.shippingFeeSelect.addEventListener('change', function() {
                const selectedOptionValue = this.value;
                if (selectedOptionValue) {
                    const parts = selectedOptionValue.split('|');
                    const cost = parseFloat(parts[0]);
                    const serviceCode = parts[1];
                    const serviceName = parts[3];

                    elements.checkoutShippingCostInput.value = cost.toFixed(2);
                    elements.checkoutShippingServiceCodeInput.value = serviceCode;
                    elements.checkoutShippingServiceNameInput.value = serviceName;
                    
                    updateGrandTotalDisplay(cost);
                    elements.proceedToCheckoutBtn.disabled = false;
                } else {
                    elements.checkoutShippingCostInput.value = 0;
                    elements.checkoutShippingServiceCodeInput.value = '';
                    elements.checkoutShippingServiceNameInput.value = '';
                    updateGrandTotalDisplay(0);
                    elements.proceedToCheckoutBtn.disabled = true;
                }
            });

            // SweetAlert for delete cart item confirmation
            document.querySelectorAll('.delete-cart-item-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formElement = this; 

                    Swal.fire({
                        title: 'Apakah Anda yakin?',
                        text: "Item ini akan dihapus dari keranjang!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33', 
                        cancelButtonColor: '#3085d6', 
                        confirmButtonText: 'Ya, hapus!',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formElement.submit();
                        }
                    });
                });
            });

            // SweetAlert for update cart item confirmation
            document.querySelectorAll('.update-cart-item-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formElement = this; 
                    const qtyInput = formElement.querySelector('input[name="qty"]');
                    const currentQty = parseInt(qtyInput.defaultValue);
                    const newQty = parseInt(qtyInput.value);
                    const maxStock = parseInt(qtyInput.max);

                    if (newQty < 1) {
                        Swal.fire('Peringatan', 'Jumlah produk minimal 1.', 'warning');
                        qtyInput.value = currentQty;
                        return;
                    }
                    if (newQty > maxStock) {
                        Swal.fire('Peringatan', `Stok tidak mencukupi. Maksimal ${maxStock}.`, 'warning');
                        qtyInput.value = currentQty;
                        return;
                    }
                    if (newQty === currentQty) {
                        Swal.fire('Info', 'Tidak ada perubahan jumlah.', 'info');
                        return;
                    }

                    Swal.fire({
                        title: 'Perbarui Jumlah?',
                        text: `Anda akan mengubah jumlah produk ini dari ${currentQty} menjadi ${newQty}.`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Ya, perbarui!',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formElement.submit();
                        }
                    });
                });
            });

            // Initial state setup (when page loads)
            const initialSelectedAddressOption = elements.addressSelect.options[elements.addressSelect.selectedIndex];
            if (initialSelectedAddressOption && initialSelectedAddressOption.value) {
                selectedDestinationLocationID = initialSelectedAddressOption.dataset.locationId;
                elements.courierSelect.disabled = false; // Pastikan kurir aktif jika alamat sudah terpilih
                setShippingMessage('Pilih kurir untuk menghitung ongkos kirim.', 'success');
                
                const urlParams = new URLSearchParams(window.location.search);
                const prevShippingCost = urlParams.get('shipping_cost');
                const prevShippingServiceCode = urlParams.get('shipping_service_code');
                const prevShippingServiceName = urlParams.get('shipping_service_name');
                const prevFinalTotalPrice = urlParams.get('final_total_price');
                const prevSelectedAddressId = urlParams.get('selected_address_id');

                if (prevSelectedAddressId) {
                    elements.addressSelect.value = prevSelectedAddressId;
                    // Trigger change event manually to ensure logic runs
                    elements.addressSelect.dispatchEvent(new Event('change'));
                }

                if (prevShippingCost && prevShippingServiceCode && prevShippingServiceName) {
                    elements.checkoutShippingCostInput.value = prevShippingCost;
                    elements.checkoutShippingServiceCodeInput.value = prevShippingServiceCode;
                    elements.checkoutShippingServiceNameInput.value = prevShippingServiceName;
                    if (prevFinalTotalPrice) {
                        elements.checkoutFinalTotalPriceInput.value = prevFinalTotalPrice;
                    }
                    updateGrandTotalDisplay(prevShippingCost);
                    elements.proceedToCheckoutBtn.disabled = false;
                    
                    const courierPart = prevShippingServiceCode.split('-')[0]; 
                    elements.courierSelect.value = courierPart;
                    
                    calculateShippingCost().then(() => {
                        const targetOptionValuePrefix = `${prevShippingCost}|${prevShippingServiceCode}|${prevShippingServiceName}`;
                        
                        let foundOption = false;
                        for (let i = 0; i < elements.shippingFeeSelect.options.length; i++) {
                            const option = elements.shippingFeeSelect.options[i];
                            if (option.value.startsWith(targetOptionValuePrefix)) {
                                elements.shippingFeeSelect.value = option.value;
                                foundOption = true;
                                break;
                            }
                        }
                        if (!foundOption) {
                            console.warn('Previous shipping option not found in newly loaded options. Attempting partial match.');
                            const fallbackTargetPrefix = `${prevShippingCost}|${prevShippingServiceCode}`;
                            for (let i = 0; i < elements.shippingFeeSelect.options.length; i++) {
                                const option = elements.shippingFeeSelect.options[i];
                                if (option.value.startsWith(fallbackTargetPrefix)) {
                                    elements.shippingFeeSelect.value = option.value;
                                    break;
                                }
                            }
                        }
                    });
                }
            } else {
                setShippingMessage('Mohon pilih alamat pengiriman.', 'warning');
            }

            updateGrandTotalDisplay(elements.checkoutShippingCostInput.value); 
        });
    </script>


{{ end }}