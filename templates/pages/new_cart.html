{{ define "carts" }}

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .animate-fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
    </style>

    
    <section class="flex-grow max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center lg:text-left">
            ðŸ›’ Keranjang Belanja Anda
        </h1>

        {{ if .Message }}
        <div id="flash-message" class="max-w-7xl mx-auto mt-4 px-4 sm:px-6 lg:px-8 animate-fade-in-down">
            <div class="mb-4 p-4 rounded-lg relative flex items-center justify-between shadow-sm
                {{ if eq .MessageStatus "success" }} bg-green-50 border border-green-300 text-green-800
                {{ else if eq .MessageStatus "error" }} bg-red-50 border border-red-300 text-red-800
                {{ else if eq .MessageStatus "warning" }} bg-yellow-50 border border-yellow-300 text-yellow-800
                {{ else }} bg-blue-50 border border-blue-300 text-blue-800
                {{ end }}">
                <span>{{ .Message }}</span>
                <button type="button" class="ml-4 text-gray-700 hover:text-gray-900 focus:outline-none" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        {{ end }}


        {{ if .cart.CartItems }}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">

            <div class="lg:col-span-2 bg-white shadow-xl rounded-lg p-6 border border-gray-100">
                <div class="space-y-6 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">
                    
                    {{ if .updated }}
                    <div id="update-success-notification" class="relative mb-4 p-4 rounded-lg bg-emerald-50 border border-emerald-300 text-emerald-800 font-medium flex items-center gap-3 animate-fade-in">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg> âœ… Item berhasil diperbarui
                        <button type="button" class="absolute top-2 right-2 text-emerald-700 hover:text-emerald-900 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 rounded-full p-1" onclick="this.parentElement.remove()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    {{ end }}

                    {{ range .cart.CartItems }}
                        <div class="flex flex-col sm:flex-row items-center sm:items-start justify-between border-b border-gray-200 pb-6 last:border-b-0 last:pb-0 pt-4 animate-fade-in-up">
                            <div class="flex-shrink-0 mr-0 sm:mr-6 mb-4 sm:mb-0">
                                {{ if gt (len .Product.ProductImages) 0 }}
                                    <img src="/uploads/products/{{ (index .Product.ProductImages 0).Path }}" alt="{{ .Product.Name }}" class="w-28 h-28 object-cover rounded-lg shadow-md border border-gray-100">
                                {{ else }}
                                    <img src="https://placehold.co/112x112/E0E0E0/333333?text=No+Image" alt="No Image" class="w-28 h-28 object-cover rounded-lg shadow-md border border-gray-100">
                                {{ end }}
                            </div>

                            <div class="flex-1 text-center sm:text-left mb-4 sm:mb-0">    
                                <a href="/products/{{ .Product.Slug }}" class="font-semibold text-xl text-gray-800 mb-1 hover:text-emerald-600 transition duration-150 ease-in-out block">{{ .Product.Name }}</a>
                                <p class="text-sm text-gray-600">Harga Satuan (Asli): <span class="text-gray-700">{{ rupiah .Price }}</span></p>
                                {{ if or (isGreaterThanZero .DiscountPercent) (isGreaterThanZero .DiscountAmount) }}
                                    <p class="text-sm text-red-600 font-medium">Diskon: 
                                        {{ if isGreaterThanZero .DiscountPercent }}
                                            {{ .DiscountPercent.StringFixed 2 }}%
                                        {{ else }}
                                            {{ rupiah .DiscountAmount }}
                                        {{ end }}
                                    </p>
                                    <p class="text-sm text-gray-600 font-medium">Harga Setelah Diskon: <span class="font-bold text-emerald-700">{{ rupiah .FinalPriceUnit }}</span></p>
                                {{ else }}
                                    <p class="text-sm text-gray-600 font-medium">Diskon: -</p>
                                    <p class="text-sm text-gray-600 font-medium">Harga Setelah Diskon: <span class="font-bold text-emerald-700">{{ rupiah .FinalPriceUnit }}</span></p>
                                {{ end }}
                                <p class="text-sm text-emerald-600 mt-1 font-medium">Stok tersedia: <span class="font-bold">{{ .Product.Stock }}</span></p>
                            </div>

                            <div class="text-right flex flex-col items-center sm:items-end justify-between space-y-4 sm:space-y-2">
                                <div class="flex items-center gap-3">
                                    <form action="/carts/update" method="POST" class="flex items-center update-cart-item-form">
                                        <input type="hidden" name="product_id" value="{{ .ProductID }}">
                                        <input 
                                            type="number" 
                                            name="qty" 
                                            value="{{ .Qty }}" 
                                            min="1" 
                                            max="{{ .Product.Stock }}" 
                                            class="w-20 border border-gray-300 rounded-md text-center py-2 text-base font-medium focus:border-emerald-500 focus:ring-emerald-500 transition duration-150 ease-in-out"
                                        >
                                        <input type="hidden" name="_method" value="PUT">
                                        <button 
                                            type="submit" 
                                            class="ml-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 shadow-sm"
                                        >
                                            Update
                                        </button>
                                    </form>

                                    <form action="/carts/delete" method="POST" class="delete-cart-item-form">
                                        <input type="hidden" name="product_id" value="{{ .ProductID }}">
                                        <input type="hidden" name="_method" value="DELETE">
                                        <button 
                                            type="submit" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 shadow-sm"
                                        >
                                            Hapus
                                        </button>
                                    </form>
                                </div>
                                <p class="text-lg font-bold text-gray-900">Subtotal: {{ rupiah .Subtotal }}</p>
                            </div>
                        </div>
                    {{ end }}
                </div>
            </div>

            <div class="bg-white shadow-xl rounded-lg p-6 border border-gray-100 h-fit">
                <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3 border-gray-200">ðŸ§¾ Ringkasan Pesanan</h2>
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Subtotal Produk</span>
                        <span class="font-semibold">{{ rupiah .cart.BaseTotalPrice }}</span>
                    </div>
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Diskon Keranjang</span>
                        <span class="text-emerald-500 font-semibold">-{{ rupiah .cart.DiscountAmount }}</span>
                    </div>
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Pajak ({{ .cart.TaxPercent.StringFixed 2 }}%)</span>
                        <span class="text-red-600 font-semibold">+{{ rupiah .cart.TaxAmount }}</span>
                    </div>
                    <div class="border-t border-gray-200 pt-4 mt-4"></div>
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Total Berat</span>
                        <span class="font-semibold">{{ .cart.TotalWeight.StringFixed 2 }} gram</span>
                    </div>
                    <div class="flex justify-between items-center text-lg text-gray-700">
                        <span>Subtotal Pesanan (Sebelum Ongkir)</span>
                        <span class="text-emerald-700 font-semibold">{{ rupiah .cart.GrandTotal }}</span>
                    </div>
                </div>

          <form class="space-y-4 mb-6" id="checkout-form-shipping-selection">
            <div class="form-group">
                <label for="address_id" class="block text-sm font-medium text-gray-700 mb-1">Pilih Alamat Pengiriman</label>
                <select name="address_id" id="address_id" class="form-control block w-full border-gray-300 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2.5">
                    <option value="" selected>--Pilih Alamat--</option>
                    {{ range .Addresses }}
                    <option value="{{ .ID }}" 
                            data-location-id="{{ .LocationID }}" {{/* Ini adalah ID RajaOngkir, tipe int di Go, tapi dikirim sebagai string */}}
                            data-location-name="{{ .LocationName }}"
                            {{ if eq .ID $.PrimaryAddress.ID }}selected{{ end }}> {{/* Menggunakan $.PrimaryAddress.ID untuk membandingkan */}}
                        {{ .Name }} ({{ .Address1 }}, {{ .LocationName }})
                    </option>
                    {{ end }}
                </select>
            </div>

            <div class="form-group">
                <label for="destination_location_name_display" class="block text-sm font-medium text-gray-700 mb-1">Alamat Tujuan</label>
                <input type="text" id="destination_location_name_display" 
                    class="form-control block w-full border-gray-300 rounded-md shadow-sm bg-gray-100 sm:text-sm p-2.5" readonly
                    value="{{ if .PrimaryAddress }}{{ .PrimaryAddress.LocationName }}{{ end }}"> {{/* Pre-fill jika ada primary address */}}
                
                <!-- PERUBAHAN KRUSIAL: Tambahkan name="destination_id" dan value awal -->
                <input type="hidden" id="destination_location_id_input" name="destination_id" 
                   value="{{ if .PrimaryAddress }}{{ .PrimaryAddress.LocationID }}{{ end }}"> {{/* Pre-fill jika ada primary address */}}
            </div>

            <div class="form-group">
                <label for="courier" class="block text-sm font-medium text-gray-700 mb-1">Pilih Kurir</label>
                <select name="courier" id="courier" class="form-control block w-full border-gray-300 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2.5" disabled>
                    <option value="">--Pilih Kurir--</option>
                    {{ range .couriers }} {{/* Pastikan .couriers ini tersedia di data template Anda */}}
                    <option value="{{ .Code }}">{{ .Name }}</option>
                    {{ end }}
                </select>
            </div>
            <div class="form-group">
                <label for="shipping_fee_options" class="block text-sm font-medium text-gray-700 mb-1">Pilih Opsi Pengiriman</label>
                <select name="shipping_fee_options" id="shipping_fee_options" class="form-control block w-full border-gray-300 rounded-md shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2.5" disabled>    
                    <option value="" selected>--Pilih Opsi Pengiriman--</option>
                </select>
            </div>
            <input type="hidden" id="total_weight_input" value="{{ .cart.TotalWeight.InexactFloat64 }}">
            <input type="hidden" id="origin_location_id_input" value="{{ .OriginLocationID }}"> {{/* Pastikan ini ada dari handler */}}
            
            <div class="mt-8 pt-4 border-t border-gray-200">
                <div class="flex justify-between text-base font-medium text-gray-900">
                    <p>Subtotal Pengiriman</p>
                    <p id="shipping-fee-display">{{ rupiah .cart.ShippingCost }}</p>
                </div>
                <p id="shipping-calculation-msg" class="text-sm mt-2 text-gray-600"></p>
                <div class="flex justify-between text-base font-semibold text-gray-900 mt-4">
                    <p>Total Pembayaran</p>
                    <p id="grand-total-display">{{ rupiah .cart.GrandTotal }}</p>
                </div>
                <input type="hidden" id="cart_grand_total_amount_for_js" value="{{ .cart.GrandTotal.InexactFloat64 }}">
            </div>
        </form>
        
                <form method="POST" action="/checkout/process" id="final-checkout-form"> 
                    <input type="hidden" id="checkout_shipping_cost" name="shipping_cost" value="0">
                    <input type="hidden" id="checkout_shipping_service_code" name="shippingservicecode" value="">
                    <input type="hidden" id="checkout_shipping_service_name" name="shippingservicename" value="">
                    <input type="hidden" id="checkout_selected_address_id" name="addressid" value="">
                    <input type="hidden" id="checkout_final_total_price" name="final_total_price" value="0">
                    

                    <button type="submit" id="proceedToCheckoutBtn" class="w-full mt-2 bg-emerald-600 text-white py-3 px-4 rounded-lg hover:bg-emerald-700 text-lg font-semibold shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Lanjutkan ke Pembayaran
                    </button>
                </form>
            </div>
        </div>

        {{ else }}
        <div class="bg-white p-12 rounded-lg shadow-lg text-center mt-12 border border-gray-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-24 w-24 text-gray-400 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.3 5.6a1 1 0 001 1.4h12.6a1 1 0 001-1.4L17 13m-2-8a1 1 0 100-2 1 1 0 000 2zM9 21a1 1 0 100-2 1 1 0 000 2z" />
            </svg>
            <p class="text-2xl text-gray-600 font-semibold mb-6">Keranjang Anda masih kosong.</p>
            <a href="/products" class="inline-flex items-center bg-emerald-600 text-white py-3 px-6 rounded-lg hover:bg-emerald-700 text-lg font-semibold shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                Mulai Belanja Sekarang
            </a>
        </div>
        {{ end }}

    </section>



    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 
    <script>
        /**
         * @param {number|string} amount - Jumlah yang akan diformat.
         * @returns {string} - String format Rupiah.
         */
        function formatCurrency(amount) {
            const num = parseFloat(amount);
            if (isNaN(num)) {
                return "Rp 0";
            }
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(num);
        }

        document.addEventListener('DOMContentLoaded', function() {
          
            const elements = {
                addressSelect: document.getElementById('address_id'),
                destinationLocationNameDisplay: document.getElementById('destination_location_name_display'),
                destinationLocationIdInput: document.getElementById('destination_location_id_input'),
                courierSelect: document.getElementById('courier'),
                shippingFeeSelect: document.getElementById('shipping_fee_options'),
                shippingCalculationMsg: document.getElementById('shipping-calculation-msg'),
                shippingFeeDisplay: document.getElementById('shipping-fee-display'),
                grandTotalDisplay: document.getElementById('grand-total-display'),
                cartGrandTotalAmountForJs: document.getElementById('cart_grand_total_amount_for_js'),
                totalWeightInput: document.getElementById('total_weight_input'),
                originLocationIDInput: document.getElementById('origin_location_id_input'),
                proceedToCheckoutBtn: document.getElementById('proceedToCheckoutBtn'),
                checkoutShippingCostInput: document.getElementById('checkout_shipping_cost'),
                checkoutShippingServiceCodeInput: document.getElementById('checkout_shipping_service_code'),
                checkoutShippingServiceNameInput: document.getElementById('checkout_shipping_service_name'),
                checkoutSelectedAddressIdInput: document.getElementById('checkout_selected_address_id'),
                checkoutFinalTotalPriceInput: document.getElementById('checkout_final_total_price'),
            };

            let selectedAddressData = null; // Untuk menyimpan LocationID dan LocationName alamat yang dipilih

            // Pastikan totalWeight adalah angka dan lebih besar dari 0
            let totalWeight = 1; // Default ke 1 gram untuk menghindari pembagian nol atau berat tidak valid untuk API
            if (elements.totalWeightInput && !isNaN(parseFloat(elements.totalWeightInput.value))) {
                totalWeight = parseFloat(elements.totalWeightInput.value);
                if (totalWeight <= 0) {
                    totalWeight = 1; // Berat minimum untuk API
                }
            }

            let originLocationID = 0; // Default ke 0
            if (elements.originLocationIDInput && elements.originLocationIDInput.value) {
                const parsedOriginID = parseInt(elements.originLocationIDInput.value, 10);
                if (!isNaN(parsedOriginID)) {
                    originLocationID = parsedOriginID;
                } else {
                    console.error('Peringatan: Nilai origin_location_id_input bukan angka yang valid:', elements.originLocationIDInput.value);
                }
            }

            let cartSubtotal = 0; // Ini adalah .cart.GrandTotal dari Go, yang mencakup diskon item dan pajak tetapi bukan ongkos kirim
            if (elements.cartGrandTotalAmountForJs && !isNaN(parseFloat(elements.cartGrandTotalAmountForJs.value))) {
                cartSubtotal = parseFloat(elements.cartGrandTotalAmountForJs.value);
            }

            /**
             * Memperbarui tampilan total pembayaran.
             * @param {number|string} selectedShippingCostValue - Biaya pengiriman yang dipilih.
             */
            function updateGrandTotalDisplay(selectedShippingCostValue = 0) {
                const currentShippingFee = parseFloat(selectedShippingCostValue) || 0;
                const grandTotalCalculated = cartSubtotal + currentShippingFee;

                elements.shippingFeeDisplay.textContent = formatCurrency(currentShippingFee);
                elements.grandTotalDisplay.textContent = formatCurrency(grandTotalCalculated);
                elements.checkoutFinalTotalPriceInput.value = grandTotalCalculated.toFixed(2);
            }

            /**
             * Mereset elemen-elemen terkait pengiriman.
             * @param {Object} [options] - Opsi reset.
             * @param {boolean} [options.resetCourier=true] - Apakah akan mereset kurir.
             * @param {boolean} [options.resetShippingFee=true] - Apakah akan mereset opsi pengiriman.
             * @param {string} [options.courierDefaultText='--Pilih Kurir--'] - Teks default untuk kurir.
             * @param {string} [options.shippingFeeDefaultText='--Pilih Opsi Pengiriman--'] - Teks default untuk opsi pengiriman.
             */
            function resetShippingElements({
                resetCourier = true,
                resetShippingFee = true,
                courierDefaultText = '--Pilih Kurir--',
                shippingFeeDefaultText = '--Pilih Opsi Pengiriman--'
            } = {}) {
                if (resetCourier) {
                    elements.courierSelect.value = "";
                    elements.courierSelect.disabled = true;
                }
                if (resetShippingFee) {
                    elements.shippingFeeSelect.innerHTML = `<option value="" selected>${shippingFeeDefaultText}</option>`;
                    elements.shippingFeeSelect.disabled = true;
                    elements.checkoutShippingCostInput.value = 0;
                    elements.checkoutShippingServiceCodeInput.value = '';
                    elements.checkoutShippingServiceNameInput.value = '';
                    elements.proceedToCheckoutBtn.disabled = true;
                }
                setShippingMessage('');
                updateGrandTotalDisplay(0); // Reset total pembayaran ke total keranjang awal
            }

            /**
             * Menampilkan pesan terkait perhitungan pengiriman.
             * @param {string} message - Pesan yang akan ditampilkan.
             * @param {'success'|'warning'|'error'|''} type - Tipe pesan (untuk styling).
             */
            function setShippingMessage(message, type = '') {
                elements.shippingCalculationMsg.textContent = message;
                elements.shippingCalculationMsg.className = 'text-sm mt-2'; // Reset kelas

                elements.shippingCalculationMsg.classList.remove('text-red-500', 'text-yellow-500', 'text-green-500');
                if (type === 'error') {
                    elements.shippingCalculationMsg.classList.add('text-red-500');
                } else if (type === 'warning') {
                    elements.shippingCalculationMsg.classList.add('text-yellow-500');
                } else if (type === 'success') {
                    elements.shippingCalculationMsg.classList.add('text-green-500');
                }
            }

            // Fungsi untuk menghitung biaya pengiriman menggunakan API Komerce
            async function calculateShippingCost() {
                const destinationLocationID = elements.destinationLocationIdInput.value;
                const courier = elements.courierSelect.value;

                resetShippingElements({ resetCourier: false, resetShippingFee: true });

                console.log('--- Menghitung Biaya Pengiriman ---');
                console.log('originLocationID (dari HTML):', elements.originLocationIDInput.value);
                console.log('Parsed originLocationID (JS int):', originLocationID);
                console.log('destinationLocationID (dari HTML):', destinationLocationID);
                console.log('Parsed destinationLocationID (JS int):', parseInt(destinationLocationID, 10));
                console.log('totalWeight:', totalWeight);
                console.log('courier:', courier);

                if (originLocationID === 0) {
                    setShippingMessage('Kota asal pengiriman belum ditentukan (konfigurasi backend).', 'error');
                    return;
                }
                if (totalWeight <= 0) {
                    setShippingMessage('Berat total produk harus lebih dari 0.', 'error');
                    return;
                }
                if (!destinationLocationID || parseInt(destinationLocationID, 10) === 0) {
                    setShippingMessage('Mohon pilih Alamat Pengiriman yang valid.', 'warning');
                    return;
                }
                if (!courier) {
                    setShippingMessage('Mohon pilih Kurir.', 'warning');
                    return;
                }

                setShippingMessage('Memuat opsi pengiriman...', 'warning');
                elements.shippingFeeSelect.innerHTML = '<option value="" selected>--Memuat Opsi Pengiriman--</option>';
                
                try {
                    const response = await fetch('/api/komerce/calculate-shipping-cost', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            origin: originLocationID,
                            destination: parseInt(destinationLocationID, 10),
                            weight: totalWeight,
                            courier: courier,
                            price: "lowest" 
                        })
                    });

                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        let displayMessage = data.message || `Error ${response.status}: Gagal menghitung ongkos kirim.`;
                        
                        if (response.status === 404 && data.meta && data.meta.message && data.meta.message.includes("Calculate Domestic Shipping Cost not found")) {
                            displayMessage = `Opsi pengiriman tidak tersedia untuk kurir '${courier}' pada rute ini. Mohon coba kurir lain atau hubungi dukungan.`;
                        } else if (response.status === 400 && data.meta && data.meta.message) {
                            displayMessage = `Kesalahan validasi dari API: ${data.meta.message}. Mohon periksa input Anda.`;
                        }

                        throw new Error(displayMessage);
                    }

                    elements.shippingFeeSelect.innerHTML = '<option value="" selected>--Pilih Opsi Pengiriman--</option>';

                    let optionsFound = false; 
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(service => { 
                            const serviceName = `${service.name} - ${service.service} (${service.description})`; 
                            const costValue = service.cost; 
                            const etd = service.etd; 
                            
                            const optionText = `${serviceName} - ${formatCurrency(costValue)} (Estimasi: ${etd} hari)`;
                            const optionValue = `${costValue}|${service.code}|${service.service}`; 
                            const option = new Option(optionText, optionValue);
                            elements.shippingFeeSelect.add(option);
                            optionsFound = true; 
                        });
                    }

                    if (optionsFound) {
                        elements.shippingFeeSelect.disabled = false;
                        setShippingMessage('Pilih opsi pengiriman.', 'success');
                    } else {
                        setShippingMessage('Tidak ada opsi pengiriman tersedia untuk rute dan kurir ini. Coba kurir lain atau periksa rute.', 'warning');
                        elements.shippingFeeSelect.innerHTML = '<option value="" selected>--Tidak Tersedia--</option>';
                    }
                } catch (error) {
                    console.error('Error dalam calculateShippingCost:', error);
                    setShippingMessage(error.message || 'Terjadi kesalahan jaringan saat menghitung ongkir.', 'error');
                    elements.shippingFeeSelect.innerHTML = '<option value="" selected>--Gagal Memuat--</option>';
                } finally {
                    updateGrandTotalDisplay(0);
                }
            }

            // --- Event Listeners ---

            // SweetAlert untuk konfirmasi hapus
            document.querySelectorAll('.delete-cart-item-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formElement = this; 

                    Swal.fire({
                        title: 'Apakah Anda yakin?',
                        text: 'Item ini akan dihapus dari keranjang!',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33', 
                        cancelButtonColor: '#3085d6', 
                        confirmButtonText: 'Ya, hapus!',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formElement.submit();
                        }
                    });
                });
            });

            // SweetAlert untuk konfirmasi update
            document.querySelectorAll('.update-cart-item-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formElement = this; 

                    Swal.fire({
                        title: 'Perbarui Kuantitas?',
                        text: 'Apakah Anda ingin memperbarui kuantitas item ini?',
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6', 
                        cancelButtonColor: '#d33', 
                        confirmButtonText: 'Ya, perbarui!',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formElement.submit();
                        }
                    });
                });
            });

            // Penanganan pesan flash
            const flashMessage = document.getElementById('flash-message');
            if (flashMessage) {
                setTimeout(() => {
                    flashMessage.classList.add('animate-fade-out');
                    flashMessage.addEventListener('animationend', () => {
                        flashMessage.remove();
                    });
                }, 5000);
            }

            // Event listener untuk pemilihan alamat
            if (elements.addressSelect) { 
                elements.addressSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.value) { 
                        selectedAddressData = {
                            addressId: selectedOption.value, 
                            locationId: selectedOption.dataset.locationId,
                            locationName: selectedOption.dataset.locationName
                        };
                        
                        elements.destinationLocationNameDisplay.value = selectedAddressData.locationName;
                        elements.destinationLocationIdInput.value = selectedAddressData.locationId; 
                        elements.checkoutSelectedAddressIdInput.value = selectedAddressData.addressId; 

                        resetShippingElements({ resetCourier: true, resetShippingFee: true }); 
                        elements.courierSelect.disabled = false;
                        setShippingMessage('Pilih kurir untuk melihat opsi pengiriman.', 'info');

                    } else { // Opsi "--Pilih Alamat--" dipilih
                        selectedAddressData = null;
                        elements.destinationLocationNameDisplay.value = '';
                        elements.destinationLocationIdInput.value = '';
                        elements.checkoutSelectedAddressIdInput.value = '';
                        resetShippingElements(); 
                        setShippingMessage('Pilih alamat pengiriman terlebih dahulu.', 'warning');
                    }
                });
            }

            // Event listener untuk pemilihan kurir
            if (elements.courierSelect) { 
                elements.courierSelect.addEventListener('change', function() {
                    if (this.value && elements.addressSelect && elements.addressSelect.value) { 
                        calculateShippingCost();
                    } else {
                        resetShippingElements({ resetCourier: false, resetShippingFee: true });
                        setShippingMessage('Pilih alamat dan kurir untuk melihat opsi pengiriman.', 'warning');
                    }
                });
            }

            // Event listener untuk pemilihan opsi pengiriman
            if (elements.shippingFeeSelect) { 
                elements.shippingFeeSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.value) {
                        const [cost, serviceCode, serviceName] = selectedOption.value.split('|');
                        updateGrandTotalDisplay(cost);
                        elements.checkoutShippingCostInput.value = cost;
                        elements.checkoutShippingServiceCodeInput.value = serviceCode;
                        elements.checkoutShippingServiceNameInput.value = serviceName;
                        elements.proceedToCheckoutBtn.disabled = false;
                        setShippingMessage('Ongkos kirim berhasil dihitung.', 'success');
                    } else {
                        updateGrandTotalDisplay(0);
                        elements.checkoutShippingCostInput.value = 0;
                        elements.checkoutShippingServiceCodeInput.value = '';
                        elements.checkoutShippingServiceNameInput.value = '';
                        elements.proceedToCheckoutBtn.disabled = true;
                        setShippingMessage('Pilih opsi pengiriman.', 'warning');
                    }
                });
            }

            // Pengaturan status awal untuk alamat dan opsi pengiriman
            // Jika alamat sudah dipilih sebelumnya (misalnya alamat utama), picu event 'change'
            if (elements.addressSelect && elements.addressSelect.value) {
                const event = new Event('change');
                elements.addressSelect.dispatchEvent(event);
            } else {
                // Jika tidak ada alamat yang dipilih di awal, nonaktifkan pemilihan kurir
                if (elements.courierSelect) elements.courierSelect.disabled = true;
                if (elements.shippingFeeSelect) elements.shippingFeeSelect.disabled = true;
                setShippingMessage('Pilih alamat pengiriman terlebih dahulu.', 'warning');
            }
        });
    </script>
{{ end }}
