{{ define "checkout/process" }}

<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center lg:text-left">
        ðŸ§¾ Konfirmasi Pesanan Anda
    </h1>

    {{ if .Message }}
    <div id="flash-message" class="max-w-7xl mx-auto mt-4 px-4 sm:px-6 lg:px-8 animate-fade-in-down">
        <div class="mb-4 p-4 rounded-lg relative flex items-center justify-between shadow-sm
                {{ if eq .MessageStatus "success" }} bg-green-50 border border-green-300 text-green-800
                {{ else if eq .MessageStatus "error" }} bg-red-50 border border-red-300 text-red-800
                {{ else if eq .MessageStatus "warning" }} bg-yellow-50 border border-yellow-300 text-yellow-800
                {{ else }} bg-blue-50 border border-blue-300 text-blue-800
                {{ end }}">
            <span>{{ .Message }}</span>
            <button type="button" class="ml-4 text-gray-700 hover:text-gray-900 focus:outline-none" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    {{ end }}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
        <div class="lg:col-span-2 bg-white shadow-xl rounded-lg p-6 border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3 border-gray-200">Daftar Produk</h2>
            <div class="space-y-6 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                {{ if .Cart.CartItems }}
                {{ range .Cart.CartItems }}
                <div class="flex flex-col sm:flex-row items-center sm:items-start justify-between border-b border-gray-200 pb-6 last:border-b-0 last:pb-0 pt-4 animate-fade-in-up">
                     <div class="flex-shrink-0 mr-0 sm:mr-6 mb-4 sm:mb-0">
                            {{ $imageURL := "https://placehold.co/112x112/E0E0E0/333333?text=No+Image" }}
                            {{ if gt (len .Product.ProductImages) 0 }}
                                {{ $imageURL = (index .Product.ProductImages 0).Path }} 
                            {{ end }}
                            <img src="{{ $imageURL }}" alt="{{ .Product.Name }}" class="w-28 h-28 object-cover rounded-lg shadow-md border border-gray-100">
                        </div>
                    <div class="flex-1 text-center sm:text-left mb-4 sm:mb-0">
                        <p class="font-semibold text-xl text-gray-800 mb-1">{{ .Product.Name }}</p>
                        <p class="text-sm text-gray-600">Jumlah: {{ .Qty }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-gray-900">{{ rupiah .Subtotal }}</p>
                    </div>
                </div>
                {{ end }}
                {{ else }}
                <p class="text-gray-600 text-center">Tidak ada produk di keranjang Anda.</p>
                {{ end }}
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-lg p-6 border border-gray-100 h-fit">
            <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-3 border-gray-200">Detail Pesanan</h2>
            <div class="space-y-3 mb-6">
                <div class="flex justify-between items-center text-lg text-gray-700">
                    <span>Subtotal Produk</span>
                    <span class="font-semibold">{{ rupiah .Cart.BaseTotalPrice }}</span>
                </div>
                <div class="flex justify-between items-center text-lg text-gray-700">
                    <span>Diskon</span>
                    <span class="text-emerald-500 font-semibold">-{{ rupiah .Cart.DiscountAmount }}</span>
                </div>
                <div class="flex justify-between items-center text-lg text-gray-700">
                    <span>Pajak ({{ .Cart.TaxPercent.StringFixed 2 }}%)</span>
                    <span class="text-red-600 font-semibold">+{{ rupiah .Cart.TaxAmount }}</span>
                </div>
                <div class="flex justify-between items-center text-lg text-gray-700">
                    <span>Ongkos Kirim ({{ .ShippingServiceCode }} - {{ .ShippingServiceName }})</span>
                    <span class="font-semibold">{{ rupiah .ShippingCost }}</span>
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4"></div>
                <div class="flex justify-between items-center text-xl font-bold text-gray-900">
                    <span>Total Pembayaran</span>
                    <span id="final-total-display" class="text-emerald-700">{{ rupiah .FinalTotalPrice }}</span>
                </div>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 border-gray-200">Alamat Pengiriman</h3>
            {{ with .SelectedAddress }}
            <div class="text-gray-700 text-base space-y-1 mb-6">
                <p><strong>{{ .Name }}</strong></p>
                <p>{{ .Address1 }}</p>
                {{ if .Address2 }}<p>{{ .Address2 }}</p>{{ end }}
                <p>{{ .LocationName }}, {{ .PostCode }}</p>
                <p>Telepon: {{ .Phone }}</p>
                <p>Email: {{ .Email }}</p>
            </div>
            {{ else }}
            <p class="text-red-500 text-base mb-6">Alamat pengiriman tidak ditemukan.</p>
            {{ end }}

            <!-- Hidden inputs untuk data yang akan dikirim ke JavaScript -->
            <input type="hidden" id="checkout_address_id_js" value="{{ if .SelectedAddress }}{{ .SelectedAddress.ID }}{{ end }}">
            <input type="hidden" id="checkout_shipping_cost_js" value="{{ .ShippingCost.InexactFloat64 }}">
            <input type="hidden" id="checkout_shipping_service_code_js" value="{{ .ShippingServiceCode }}">
            <input type="hidden" id="checkout_shipping_service_name_js" value="{{ .ShippingServiceName }}">
            <input type="hidden" id="checkout_final_total_price_js" value="{{ .FinalTotalPrice.InexactFloat64 }}">

            <button id="pay-button" class="w-full mt-4 bg-emerald-600 text-white py-3 px-4 rounded-lg hover:bg-emerald-700 text-lg font-semibold shadow-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">
                Bayar Sekarang dengan Midtrans
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }

    .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }

    .animate-fade-in-down {
        animation: fadeIn 0.5s ease-out forwards;
    }

    .animate-fade-out {
        animation: fadeOut 0.5s ease-out forwards;
    }


    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const flashMessage = document.getElementById('flash-message');
        if (flashMessage) {
            setTimeout(() => {
                flashMessage.classList.add('animate-fade-out');
                flashMessage.addEventListener('animationend', () => {
                    flashMessage.remove();
                });
            }, 5000);
        }

        const payButton = document.getElementById('pay-button');
        if (payButton) {
            payButton.addEventListener('click', function() {
                // Ambil nilai dari hidden inputs
                const addressID = document.getElementById('checkout_address_id_js').value;
                const shippingCost = parseFloat(document.getElementById('checkout_shipping_cost_js').value);
                const shippingServiceCode = document.getElementById('checkout_shipping_service_code_js').value;
                const shippingServiceName = document.getElementById('checkout_shipping_service_name_js').value;
                const finalTotalPrice = parseFloat(document.getElementById('checkout_final_total_price_js').value);

                // Validasi sederhana di frontend sebelum mengirim
                if (!addressID || isNaN(shippingCost) || !shippingServiceCode || !shippingServiceName || isNaN(finalTotalPrice) || finalTotalPrice <= 0) {
                    Swal.fire('Error', 'Data pembayaran tidak lengkap atau tidak valid. Mohon kembali ke keranjang dan lengkapi informasi pengiriman.', 'error');
                    return;
                }

                Swal.fire({
                    title: 'Memproses Pembayaran...',
                    text: 'Mohon tunggu sebentar. Anda akan diarahkan ke halaman pembayaran Midtrans.', 
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                fetch('/checkout/initiate-midtrans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address_id: addressID,
                        shipping_cost: shippingCost,
                        shipping_service_code: shippingServiceCode,
                        shipping_service_name: shippingServiceName,
                        gross_amount: finalTotalPrice,
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Gagal mengambil URL pembayaran.'); });
                    }
                    return response.json();
                })
                .then(data => {
                    Swal.close(); // Tutup loading SweetAlert
                    if (data.token) { // data.token dari backend sebenarnya adalah redirect_url
                        window.location.href = data.token;
                    } else {
                        Swal.fire('Error', 'Gagal mendapatkan URL pembayaran dari Midtrans.', 'error');
                    }
                })
                .catch(error => {
                    Swal.close(); // Tutup loading SweetAlert
                    console.error('Error initiating Midtrans transaction:', error);
                    Swal.fire('Error', error.message || 'Terjadi kesalahan saat memulai pembayaran.', 'error');
                });
            });
        }
    })
</script>

{{ end }}
